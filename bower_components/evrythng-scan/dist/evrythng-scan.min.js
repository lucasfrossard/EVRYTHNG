!function(a,b){"use strict";"function"==typeof define&&define.amd?define(b()):a.EVT.Scan=a.Evrythng.Scan=b()}(this,function(){var a,b,c;return function(d){function e(a,b){return u.call(a,b)}function f(a,b){var c,d,e,f,g,h,i,j,k,l,m,n=b&&b.split("/"),o=s.map,p=o&&o["*"]||{};if(a&&"."===a.charAt(0))if(b){for(a=a.split("/"),g=a.length-1,s.nodeIdCompat&&w.test(a[g])&&(a[g]=a[g].replace(w,"")),a=n.slice(0,n.length-1).concat(a),k=0;k<a.length;k+=1)if(m=a[k],"."===m)a.splice(k,1),k-=1;else if(".."===m){if(1===k&&(".."===a[2]||".."===a[0]))break;k>0&&(a.splice(k-1,2),k-=2)}a=a.join("/")}else 0===a.indexOf("./")&&(a=a.substring(2));if((n||p)&&o){for(c=a.split("/"),k=c.length;k>0;k-=1){if(d=c.slice(0,k).join("/"),n)for(l=n.length;l>0;l-=1)if(e=o[n.slice(0,l).join("/")],e&&(e=e[d])){f=e,h=k;break}if(f)break;!i&&p&&p[d]&&(i=p[d],j=k)}!f&&i&&(f=i,h=j),f&&(c.splice(0,h,f),a=c.join("/"))}return a}function g(a,b){return function(){var c=v.call(arguments,0);return"string"!=typeof c[0]&&1===c.length&&c.push(null),n.apply(d,c.concat([a,b]))}}function h(a){return function(b){return f(b,a)}}function i(a){return function(b){q[a]=b}}function j(a){if(e(r,a)){var b=r[a];delete r[a],t[a]=!0,m.apply(d,b)}if(!e(q,a)&&!e(t,a))throw new Error("No "+a);return q[a]}function k(a){var b,c=a?a.indexOf("!"):-1;return c>-1&&(b=a.substring(0,c),a=a.substring(c+1,a.length)),[b,a]}function l(a){return function(){return s&&s.config&&s.config[a]||{}}}var m,n,o,p,q={},r={},s={},t={},u=Object.prototype.hasOwnProperty,v=[].slice,w=/\.js$/;o=function(a,b){var c,d=k(a),e=d[0];return a=d[1],e&&(e=f(e,b),c=j(e)),e?a=c&&c.normalize?c.normalize(a,h(b)):f(a,b):(a=f(a,b),d=k(a),e=d[0],a=d[1],e&&(c=j(e))),{f:e?e+"!"+a:a,n:a,pr:e,p:c}},p={require:function(a){return g(a)},exports:function(a){var b=q[a];return"undefined"!=typeof b?b:q[a]={}},module:function(a){return{id:a,uri:"",exports:q[a],config:l(a)}}},m=function(a,b,c,f){var h,k,l,m,n,s,u=[],v=typeof c;if(f=f||a,"undefined"===v||"function"===v){for(b=!b.length&&c.length?["require","exports","module"]:b,n=0;n<b.length;n+=1)if(m=o(b[n],f),k=m.f,"require"===k)u[n]=p.require(a);else if("exports"===k)u[n]=p.exports(a),s=!0;else if("module"===k)h=u[n]=p.module(a);else if(e(q,k)||e(r,k)||e(t,k))u[n]=j(k);else{if(!m.p)throw new Error(a+" missing "+k);m.p.load(m.n,g(f,!0),i(k),{}),u[n]=q[k]}l=c?c.apply(q[a],u):void 0,a&&(h&&h.exports!==d&&h.exports!==q[a]?q[a]=h.exports:l===d&&s||(q[a]=l))}else a&&(q[a]=c)},a=b=n=function(a,b,c,e,f){if("string"==typeof a)return p[a]?p[a](b):j(o(a,b).f);if(!a.splice){if(s=a,s.deps&&n(s.deps,s.callback),!b)return;b.splice?(a=b,b=c,c=null):a=d}return b=b||function(){},"function"==typeof c&&(c=e,e=f),e?m(d,a,b,c):setTimeout(function(){m(d,a,b,c)},4),n},n.config=function(a){return n(a)},a._defined=q,c=function(a,b,c){if("string"!=typeof a)throw new Error("See almond README: incorrect module build, no module name");b.splice||(c=b,b=[]),e(q,a)||e(r,a)||(r[a]=[a,b,c])},c.amd={jQuery:!0}}(),c("almond",function(){}),c("utils",[],function(){"use strict";return{isFunction:function(a){return"[object Function]"==Object.prototype.toString.call(a)},isString:function(a){return"[object String]"==Object.prototype.toString.call(a)},isArray:function(a){return"[object Array]"==Object.prototype.toString.call(a)},isObject:function(a){return a===Object(a)&&!this.isArray(a)},isDataUrl:function(a){return"[object String]"==Object.prototype.toString.call(a)&&a.match(/^\s*data:image\/(\w+)(;charset=[\w-]+)?(;base64)?,/)},extend:function(a,b,c){var d;if(c)d=a;else{d={};for(var e in a)d[e]=a[e]}for(var f in b)b.hasOwnProperty(f)&&(d[f]=b[f]);return d},isFirefoxMobileBrowser:function(){var a,b,c=navigator.userAgent.toLowerCase();return c.indexOf("firefox")>-1&&c.indexOf("mobile")>-1?(a=c.match(/firefox\/([\d.]+)/)[1],b=a.split(".")[0],b>=10):!1},isAndroidBrowser:function(){var a=window.navigator.userAgent.match(/Android.*AppleWebKit\/([\d.]+)/),b=a&&a[1]<537;return b},restoreUser:function(a,b){var c,d;return c=window.localStorage?this.readStorage("scanthng-"+a.id):this.readCookie("scanthng-"+a.id),this.isObject(c)&&(d=new b(c,a)),d},storeUser:function(a,b){var c={id:b.id,apiKey:b.apiKey};window.localStorage?this.writeStorage("scanthng-"+a.id,c):this.writeCookie("scanthng-"+a.id,c)},writeStorage:function(a,b){window.localStorage.setItem(a,JSON.stringify(b))},readStorage:function(a){var b=window.localStorage.getItem(a);return JSON.parse(b)},writeCookie:function(a,b){document.cookie=encodeURI(a)+"="+encodeURI(JSON.stringify(b))+"; expires=Tue, 19 Jan 2038 03:14:07 GMT; path=/"},readCookie:function(a){var b=decodeURI(document.cookie.replace(new RegExp("(?:^|.*;\\s*)"+decodeURI(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*((?:[^;](?!;))*[^;]?).*"),"$1"));return JSON.parse(b)}}}),function(){function a(a){var b=a.naturalWidth,c=a.naturalHeight;if(b*c>1048576){var d=document.createElement("canvas");d.width=d.height=1;var e=d.getContext("2d");return e.drawImage(a,-b+1,0),0===e.getImageData(0,0,1,1).data[3]}return!1}function b(a,b,c){var d=document.createElement("canvas");d.width=1,d.height=c;var e=d.getContext("2d");e.drawImage(a,0,0);for(var f=e.getImageData(0,0,1,c).data,g=0,h=c,i=c;i>g;){var j=f[4*(i-1)+3];0===j?h=i:g=i,i=h+g>>1}var k=i/c;return 0===k?1:k}function d(a,b,c){var d=document.createElement("canvas");return e(a,d,b,c),d.toDataURL("image/jpeg",b.quality||.8)}function e(c,d,e,g){var h=c.naturalWidth,i=c.naturalHeight;if(h+i){var j=e.width,k=e.height,l=d.getContext("2d");l.save(),f(d,l,j,k,e.orientation);var m=a(c);m&&(h/=2,i/=2);var n=1024,o=document.createElement("canvas");o.width=o.height=n;for(var p=o.getContext("2d"),q=g?b(c,h,i):1,r=Math.ceil(n*j/h),s=Math.ceil(n*k/i/q),t=0,u=0;i>t;){for(var v=0,w=0;h>v;)p.clearRect(0,0,n,n),p.drawImage(c,-v,-t),l.drawImage(o,0,0,n,n,w,u,r,s),v+=n,w+=r;t+=n,u+=s}l.restore(),o=p=null}}function f(a,b,c,d,e){switch(e){case 5:case 6:case 7:case 8:a.width=d,a.height=c;break;default:a.width=c,a.height=d}switch(e){case 2:b.translate(c,0),b.scale(-1,1);break;case 3:b.translate(c,d),b.rotate(Math.PI);break;case 4:b.translate(0,d),b.scale(1,-1);break;case 5:b.rotate(.5*Math.PI),b.scale(1,-1);break;case 6:b.rotate(.5*Math.PI),b.translate(0,-d);break;case 7:b.rotate(.5*Math.PI),b.translate(c,-d),b.scale(-1,1);break;case 8:b.rotate(-.5*Math.PI),b.translate(-c,0)}}function g(a){if(window.Blob&&a instanceof Blob){if(!h)throw Error("No createObjectURL function found to create blob url");var b=new Image;b.src=h.createObjectURL(a),this.blob=a,a=b}if(!a.naturalWidth&&!a.naturalHeight){var c=this;a.onload=a.onerror=function(){var a=c.imageLoadListeners;if(a){c.imageLoadListeners=null;for(var b=0,d=a.length;d>b;b++)a[b]()}},this.imageLoadListeners=[]}this.srcImage=a}var h=window.URL&&window.URL.createObjectURL?window.URL:window.webkitURL&&window.webkitURL.createObjectURL?window.webkitURL:null;g.prototype.render=function(a,b,c){if(this.imageLoadListeners){var f=this;return void this.imageLoadListeners.push(function(){f.render(a,b,c)})}b=b||{};var g=this.srcImage.naturalWidth,i=this.srcImage.naturalHeight,j=b.width,k=b.height,l=b.maxWidth,m=b.maxHeight,n=!this.blob||"image/jpeg"===this.blob.type;j&&!k?k=i*j/g<<0:k&&!j?j=g*k/i<<0:(j=g,k=i),l&&j>l&&(j=l,k=i*j/g<<0),m&&k>m&&(k=m,j=g*k/i<<0);var o={width:j,height:k};for(var p in b)o[p]=b[p];var q=a.tagName.toLowerCase();"img"===q?a.src=d(this.srcImage,o,n):"canvas"===q&&e(this.srcImage,a,o,n),"function"==typeof this.onrender&&this.onrender(a),c&&c(),this.blob&&(this.blob=null,h.revokeObjectURL(this.srcImage.src))},"function"==typeof c&&c.amd?c("megapix",[],function(){return g}):"object"==typeof exports?module.exports=g:this.MegaPixImage=g}(),c("prepare",["utils","megapix"],function(a,b){"use strict";function c(){return new Promise(function(b,c){var d=n.id?n.id:"scanthng"+Date.now(),e=document.createElement("form"),f=document.createElement("input");e.setAttribute("id",d),e.setAttribute("class","scanThng_form"),f.setAttribute("type","file"),f.setAttribute("name","scanThng_upload"),f.setAttribute("accept","image/*"),f.setAttribute("capture","camera"),n.invisible&&(e.style.visibility="hidden"),e.appendChild(f);var g=document.getElementsByClassName("scanThng_form");if(g.length)for(var h=0,i=g.length;i>h;h++)g[h]&&g[h].parentElement&&g[h].parentElement.removeChild(g[h]);if(document.getElementsByTagName("body")[0].appendChild(e),f.addEventListener("change",function(){var a=this.files[0];a||c(new Error("No file selected.")),b(a)}),a.isAndroidBrowser()||a.isFirefoxMobileBrowser()){var j=function(){f.click()};window.setTimeout(j.bind(this,d),800)}else f.click()})}function d(a){return new Promise(function(b,c){var d=new FileReader;d.onload=function(a){b(a.target.result)},d.onerror=function(a){c(a)},d.readAsDataURL(a)})}function e(a){return new Promise(function(b,c){var d=document.createElement("img");d.onload=function(){if("naturalHeight"in this){if(this.naturalHeight+this.naturalWidth===0)return void this.onerror()}else if(this.width+this.height===0)return void this.onerror();b(d)},d.onerror=function(){c(new Error("Invalid image"))},d.src=a})}function f(a){return new Promise(function(c){var d=document.createElement("canvas"),e=Math.max(n.imageConversion.resizeTo,m),f=a.width/a.height,h=e/Math.min(a.width,a.height),i=f>1?a.width*h:e,j=f>1?e:a.height*h,k=new b(a);k.render(d,{width:i,height:j}),n.imageConversion.greyscale&&g(d),c(d)})}function g(a){for(var b=a.getContext("2d"),c=b.getImageData(0,0,a.width,a.height),d=c.data,e=0,f=d.length;f>e;e+=4){var g=.3*d[e]+.59*d[e+1]+.11*d[e+2];d[e]=g,d[e+1]=g,d[e+2]=g}return b.putImageData(c,0,0),a}function h(a){return new Promise(function(b){var c=a.toDataURL(n.imageConversion.exportFormat,n.imageConversion.exportQuality);a=null,b(c)})}function i(b){return n={invisible:b.hasOwnProperty("invisible")?b.invisible:l.invisible,imageConversion:a.extend(l.imageConversion,b.imageConversion)}}function j(a){return i(a),c().then(d)}function k(a,b){return b&&i(b),e(a).then(f).then(h).then(function(a){return{image:a}})}var l={invisible:!0,imageConversion:{greyscale:!0,resizeTo:240,exportFormat:"image/jpeg",exportQuality:.8}},m=144,n={};return{getFile:j,processImage:k}}),function(a,b){"object"==typeof module&&module.exports?module.exports=b():"function"==typeof c&&c.amd?c("spin",b):a.Spinner=b()}(this,function(){"use strict";function a(a,b){var c,d=document.createElement(a||"div");for(c in b)d[c]=b[c];return d}function b(a){for(var b=1,c=arguments.length;c>b;b++)a.appendChild(arguments[b]);return a}function c(a,b,c,d){var e=["opacity",b,~~(100*a),c,d].join("-"),f=.01+c/d*100,g=Math.max(1-(1-a)/b*(100-f),a),h=j.substring(0,j.indexOf("Animation")).toLowerCase(),i=h&&"-"+h+"-"||"";return m[e]||(k.insertRule("@"+i+"keyframes "+e+"{0%{opacity:"+g+"}"+f+"%{opacity:"+a+"}"+(f+.01)+"%{opacity:1}"+(f+b)%100+"%{opacity:"+a+"}100%{opacity:"+g+"}}",k.cssRules.length),m[e]=1),e}function d(a,b){var c,d,e=a.style;if(b=b.charAt(0).toUpperCase()+b.slice(1),void 0!==e[b])return b;for(d=0;d<l.length;d++)if(c=l[d]+b,void 0!==e[c])return c}function e(a,b){for(var c in b)a.style[d(a,c)||c]=b[c];return a}function f(a){for(var b=1;b<arguments.length;b++){var c=arguments[b];for(var d in c)void 0===a[d]&&(a[d]=c[d])}return a}function g(a,b){return"string"==typeof a?a:a[b%a.length]}function h(a){this.opts=f(a||{},h.defaults,n)}function i(){function c(b,c){return a("<"+b+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',c)}k.addRule(".spin-vml","behavior:url(#default#VML)"),h.prototype.lines=function(a,d){function f(){return e(c("group",{coordsize:k+" "+k,coordorigin:-j+" "+-j}),{width:k,height:k})}function h(a,h,i){b(m,b(e(f(),{rotation:360/d.lines*a+"deg",left:~~h}),b(e(c("roundrect",{arcsize:d.corners}),{width:j,height:d.scale*d.width,left:d.scale*d.radius,top:-d.scale*d.width>>1,filter:i}),c("fill",{color:g(d.color,a),opacity:d.opacity}),c("stroke",{opacity:0}))))}var i,j=d.scale*(d.length+d.width),k=2*d.scale*j,l=-(d.width+d.length)*d.scale*2+"px",m=e(f(),{position:"absolute",top:l,left:l});if(d.shadow)for(i=1;i<=d.lines;i++)h(i,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(i=1;i<=d.lines;i++)h(i);return b(a,m)},h.prototype.opacity=function(a,b,c,d){var e=a.firstChild;d=d.shadow&&d.lines||0,e&&b+d<e.childNodes.length&&(e=e.childNodes[b+d],e=e&&e.firstChild,e=e&&e.firstChild,e&&(e.opacity=c))}}var j,k,l=["webkit","Moz","ms","O"],m={},n={lines:12,length:7,width:5,radius:10,scale:1,corners:1,color:"#000",opacity:.25,rotate:0,direction:1,speed:1,trail:100,fps:20,zIndex:2e9,className:"spinner",top:"50%",left:"50%",shadow:!1,hwaccel:!1,position:"absolute"};if(h.defaults={},f(h.prototype,{spin:function(b){this.stop();var c=this,d=c.opts,f=c.el=a(null,{className:d.className});if(e(f,{position:d.position,width:0,zIndex:d.zIndex,left:d.left,top:d.top}),b&&b.insertBefore(f,b.firstChild||null),f.setAttribute("role","progressbar"),c.lines(f,c.opts),!j){var g,h=0,i=(d.lines-1)*(1-d.direction)/2,k=d.fps,l=k/d.speed,m=(1-d.opacity)/(l*d.trail/100),n=l/d.lines;!function o(){h++;for(var a=0;a<d.lines;a++)g=Math.max(1-(h+(d.lines-a)*n)%l*m,d.opacity),c.opacity(f,a*d.direction+i,g,d);c.timeout=c.el&&setTimeout(o,~~(1e3/k))}()}return c},stop:function(){var a=this.el;return a&&(clearTimeout(this.timeout),a.parentNode&&a.parentNode.removeChild(a),this.el=void 0),this},lines:function(d,f){function h(b,c){return e(a(),{position:"absolute",width:f.scale*(f.length+f.width)+"px",height:f.scale*f.width+"px",background:b,boxShadow:c,transformOrigin:"left",transform:"rotate("+~~(360/f.lines*k+f.rotate)+"deg) translate("+f.scale*f.radius+"px,0)",borderRadius:(f.corners*f.scale*f.width>>1)+"px"})}for(var i,k=0,l=(f.lines-1)*(1-f.direction)/2;k<f.lines;k++)i=e(a(),{position:"absolute",top:1+~(f.scale*f.width/2)+"px",transform:f.hwaccel?"translate3d(0,0,0)":"",opacity:f.opacity,animation:j&&c(f.opacity,f.trail,l+k*f.direction,f.lines)+" "+1/f.speed+"s linear infinite"}),f.shadow&&b(i,e(h("#000","0 0 4px #000"),{top:"2px"})),b(d,b(i,h(g(f.color,k),"0 0 1px rgba(0,0,0,.1)")));return d},opacity:function(a,b,c){b<a.childNodes.length&&(a.childNodes[b].style.opacity=c)}}),"undefined"!=typeof document){k=function(){var c=a("style",{type:"text/css"});return b(document.getElementsByTagName("head")[0],c),c.sheet||c.styleSheet}();var o=e(a("group"),{behavior:"url(#default#VML)"});!d(o,"transform")&&o.adj?i():j=d(o,"animation")}return h}),c("evrythng-scan",["utils","prepare","spin"],function(a,b,c){"use strict";function d(b,c){var d=a.extend(b,c);return c&&c.spinner&&(d.spinner=a.extend(b.spinner,c.spinner),c.spinner.options&&(d.spinner.options=a.extend(b.spinner?b.spinner.options:{},c.spinner.options))),d}function e(){o.spinner.enabled&&(p=new c(o.spinner.options),p.spin(),o.spinner.appendTo.appendChild(p.el))}function f(a){var b={};b[o.type]=!0,"objpic"===o.type&&o.threshold>0&&(b.threshold=Math.max(r.threshold,Math.min(o.threshold,u)));var c={url:s,method:"post",authorization:n.apiKey,params:b,data:a};return o.timeout&&(c.timeout=o.timeout),m.api(c)}function g(b){function c(a,b){var c=a.type[0].toUpperCase()+a.type.slice(1),d=b[a.type](a.evrythngId);return new m.Entity[c]({id:a.evrythngId},d)}return h().then(function(d){return a.isObject(d)&&(a.isArray(b)&&b.length?(b.forEach(function(a,e){b[e][a.type]=c(a,d)}),b=b.length>1?{data:b}:b[0]):b[b.type]=c(b,d),b.user=d),b})}function h(){if(o.createAnonymousUser){var b=a.restoreUser(n,m.User);return a.isObject(b)?l.resolve(b):n.appUser().create({anonymous:!0}).then(function(b){return a.storeUser(n,b),b})}return l.resolve()}function i(b){if(o.createScanAction&&!a.isArray(b.data||b)){var c,d=b[b.type];return a.isObject(d)||(d=n,c={shortId:b.shortId,shortDomain:b.shortDomain}),d.action("scans").create(c).then(function(a){return b.scan=a,b},function(){return b})}return b}function j(b){if(o.redirect&&!a.isArray(b.data||b)){var c=b.redirectUrl||b.defaultRedirectUrl,d=self||window;b.scan&&a.isArray(b.scan.reactions)&&b.scan.reactions.forEach(function(a){"redirection"===a.type&&(c=a.redirectUrl)}),d.location.href=c}return b}function k(a){return e(),f(a).then(g).then(i).then(j)}var l,m,n,o,p,q="1.0.1",r={type:"qrcode",redirect:!0,invisible:!0,threshold:0,timeout:1e4,imageConversion:{greyscale:!0,resizeTo:240},spinner:{enabled:!0,appendTo:document.getElementsByTagName("body")[0],options:{length:30,radius:48,hwaccel:!0}},createAnonymousUser:!1,createScanAction:!1},s="/scan/recognitions",t=["qrcode","1dbarcode","objpic"],u=99,v={version:q,settings:r,setup:function(b){if(!a.isObject(b))throw new TypeError("Setup should be called with an options object.");return this.settings=d(this.settings,b),this.settings},install:function(c,e){var f=this;l=c,m=e,m.App.prototype.scan=function(c,e,g,h){var i,j,m,q;n=this,a.isFunction(arguments[0])?(m=arguments[0],q=arguments[1]):a.isObject(arguments[0])?(j=arguments[0],m=arguments[1],q=arguments[2]):(i=arguments[0],a.isFunction(arguments[1])?(m=arguments[1],q=arguments[2]):(j=arguments[1],m=arguments[2],q=arguments[3])),o=d(f.settings,j);var r={invisible:o.invisible,imageConversion:o.imageConversion};return new l(function(c,d){if(-1===t.indexOf(o.type))return d(new Error("Invalid recognition type."));var e;if(a.isString(i)){if(!a.isDataUrl(i))return d(new Error("Invalid Image Data URL."));e=b.processImage(i,r)}else e=b.getFile(r).then(b.processImage);e.then(k).then(function(b){p&&p.stop(),a.isFunction(m)&&m(b),c(b)},function(b){p&&p.stop(),a.isFunction(q)&&q(b),d(b)})})}}};return v.$inject=["promise","evrythng"],v}),b("evrythng-scan")});